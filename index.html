<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TP WebVR ‚Äì SceneVR + Grabbing (fix)</title>

  <!-- A-Frame (>=1.4 pour Quest 2/3) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- A-Frame Extras (movement-controls, navmesh, etc.) -->
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>

  <!-- Physics system (CANNON-ES compatible A-Frame 1.5) -->
  <!-- NB: utiliser une version r√©cente compatible r15x -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@6.1.0/dist/aframe-physics-system.min.js"></script>

  <!-- super-hands (grabbable/draggable/stretchable) ‚Äî NE PAS charger d'autre lib "grabbable" -->
  <script src="https://unpkg.com/super-hands@4.0.3/dist/super-hands.min.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .overlay {
      position: fixed; left: 12px; top: 12px; z-index: 9;
      background: rgba(0,0,0,.55); color:#fff; padding:10px 12px; border-radius:10px;
      font-size:14px; line-height:1.35;
    }
    .overlay kbd { background:#222; padding:2px 6px; border-radius:6px; }
  </style>

  <script>
    // Rotation du rig avec le joystick droit (axe X)
    AFRAME.registerComponent('turn-with-right-joystick', {
      schema: { rig: {type: 'selector'}, speed: {default: 120} }, // degr√©s/s √† stick=1
      init() {
        this.x = 0;
        this.dead = 0.15;
        this.el.addEventListener('axismove', e => {
          if (e && e.detail && Array.isArray(e.detail.axis)) this.x = e.detail.axis[0] || 0;
        });
      },
      tick(t, dt) {
        if (!this.data.rig) return;
        const stick = Math.abs(this.x) > this.dead ? this.x : 0;
        if (!stick) return;
        const rot = this.data.rig.getAttribute('rotation');
        rot.y -= stick * this.data.speed * (dt/1000);
        this.data.rig.setAttribute('rotation', rot);
      }
    });
  </script>
</head>

<body>
  <div class="overlay">
    <strong>TP WebVR ‚Äì Ex.1 & Ex.2</strong><br/>
    üß≠ Gauche : joystick = d√©placement<br/>
    ‚Ü™Ô∏è Droit : joystick = rotation<br/>
    ü§è Saisir/rel√¢cher : g√¢chettes<br/>
    üß≤ Raycast main droite pour saisir √† distance<br/>
    üõ†Ô∏è Inspector : <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>I</kbd>
  </div>

  <a-scene
    background="color: #20252b"
    renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; sortTransparentObjects: true"
    shadow="type: pcfsoft"
    physics="driver: cannon-es; gravity: -9.8"
    vr-mode-ui="enabled: true"
  >
    <!-- Lumi√®res -->
    <a-entity light="type: ambient; intensity: 0.35; color: #ffffff"></a-entity>
    <a-entity light="type: directional; intensity: 1; castShadow: true"
              position="2 6 3" rotation="-45 30 0"></a-entity>

    <!-- Sol (statique, re√ßoit ombres) -->
    <a-plane rotation="-90 0 0" width="30" height="30"
             color="#3c424a" material="roughness:1; metalness:0"
             shadow="receive: true" static-body></a-plane>

    <!-- Objets (dynamiques, saisissables) -->
    <a-box class="grabbable" position="-1 1.25 -3" width="1" height="1" depth="1"
           color="#ff6f61" material="roughness:.6; metalness:.1"
           shadow="cast: true; receive: true" dynamic-body grabbable></a-box>

    <a-sphere class="grabbable" position="1 1.5 -3" radius="0.5"
              color="#7db5ff" material="roughness:.4; metalness:.15"
              shadow="cast: true; receive: true" dynamic-body grabbable></a-sphere>

    <a-box class="grabbable" position="0 0.5 -2.2" width="0.5" height="0.5" depth="0.5"
           color="#ffd166" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>
    <a-box class="grabbable" position="0.6 0.5 -2.2" width="0.5" height="0.5" depth="0.5"
           color="#06d6a0" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>
    <a-box class="grabbable" position="-0.6 0.5 -2.2" width="0.5" height="0.5" depth="0.5"
           color="#ef476f" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>

    <!-- Rig + Cam√©ra + Mains -->
    <a-entity id="rig" position="0 1.6 3"
              movement-controls="fly:false; speed:0.12; constrainToNavMesh:false">
      <a-entity camera look-controls wasd-controls="enabled:false"></a-entity>

      <!-- Main gauche : grab prox avec collider volum√©trique -->
      <a-entity id="leftHand"
                hand-controls="hand: left; handModelStyle: lowPoly; color: #ccccff"
                super-hands
                sphere-collider="objects: .grabbable"></a-entity>

      <!-- Main droite : raycast + grab distance + rotation du rig -->
      <a-entity id="rightHand"
                hand-controls="hand: right; handModelStyle: highPoly; color: #ffcccc"
                super-hands
                raycaster="objects: .grabbable; showLine: true; far: 8"
                line="opacity: 0.9"
                turn-with-right-joystick="rig: #rig; speed: 140"></a-entity>
    </a-entity>

    <a-sky color="#1b2026"></a-sky>
  </a-scene>
</body>
</html>
