<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TP WebVR ‚Äì SceneVR + Grabbing</title>

  <!-- A-Frame (>=1.4 pour Meta Quest 2/3) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- A-Frame Extras (movement-controls, etc.) -->
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>

  <!-- Physics system (Cannon.js) -->
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>

  <!-- super-hands (grabbable/draggable/stretchable) -->
  <script src="https://unpkg.com/super-hands@3.0.3/dist/super-hands.min.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .overlay {
      position: fixed; left: 12px; top: 12px; z-index: 9;
      background: rgba(0,0,0,.55); color:#fff; padding:10px 12px; border-radius:10px;
      font-size:14px; line-height:1.35;
    }
    .overlay kbd { background:#222; padding:2px 6px; border-radius:6px; }
  </style>

  <script>
    // Composant : tourner le rig avec le JOYSTICK DROIT
    // Ecoute les "axismove" du contr√¥leur droit et applique une rotation Y au rig.
    AFRAME.registerComponent('turn-with-right-joystick', {
      schema: {
        rig: {type: 'selector'},         // l'entit√© rig √† tourner
        turnSpeed: {default: 1.8}        // radian/s par valeur de stick (‚àí1..1)
      },
      init: function () {
        this.stickX = 0;
        // On suppose que ce composant est mis sur la main droite.
        this.el.addEventListener('axismove', (e) => {
          // Sur Quest, le thumbstick du contr√¥leur courant expose [x,y] sur axis[0], axis[1]
          // On ne prend que l‚Äôaxe horizontal pour tourner.
          if (e && e.detail && Array.isArray(e.detail.axis)) {
            this.stickX = e.detail.axis[0] || 0;
          }
        });
      },
      tick: function (time, dt) {
        if (!this.data.rig) return;
        const deltaSec = dt / 1000;
        // zone morte pour √©viter micro-tremblements
        const dead = 0.15;
        const x = Math.abs(this.stickX) > dead ? this.stickX : 0;
        if (x !== 0) {
          const rigRot = this.data.rig.getAttribute('rotation');
          rigRot.y -= x * this.data.turnSpeed;  // signe choisi pour un feeling "FPS"
          this.data.rig.setAttribute('rotation', rigRot);
        }
      }
    });
  </script>
</head>

<body>
  <div class="overlay">
    <strong>TP WebVR ‚Äì Ex.1 & Ex.2</strong><br/>
    <div>üß≠ Gauche : joystick = d√©placement</div>
    <div>‚Ü™Ô∏è Droit : joystick = rotation</div>
    <div>ü§è Saisir/rel√¢cher : g√¢chettes</div>
    <div>üß≤ Raycast (main droite) pour saisir √† distance</div>
    <div>üõ†Ô∏è Inspector : <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>I</kbd></div>
  </div>

  <a-scene
    renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; alpha: false; sortObjects: true; logarithmicDepthBuffer: true; shadowMap: true"
    shadow="type: pcfsoft"
    background="color: #20252b"
    physics="gravity: -9.8"
    vr-mode-ui="enabled: true"
  >

    <!-- Assets (textures si besoin) -->
    <a-assets>
      <!-- On peut ajouter ici des GLB/GLTF si n√©cessaires plus tard -->
    </a-assets>

    <!-- LUMI√àRES (directionnelle + ambient) -->
    <!-- Lumi√®re directionnelle qui projette des ombres r√©alistes -->
    <a-entity
      light="type: directional; intensity: 1.0; castShadow: true"
      position="2 6 3"
      rotation="-45 30 0"
      shadow="cast: true"
    ></a-entity>

    <!-- Ambient douce pour √©clairage global -->
    <a-entity light="type: ambient; intensity: 0.35; color: #ffffff"></a-entity>

    <!-- SOL (plan) ‚Äî re√ßoit les ombres + corps statique pour la physique -->
    <a-plane
      rotation="-90 0 0"
      width="30" height="30"
      color="#3c424a"
      material="roughness: 1; metalness: 0"
      shadow="receive: true"
      static-body
    ></a-plane>

    <!-- OBJETS 3D : cube + sph√®re ‚Äî projettent et re√ßoivent des ombres, dynamiques (physique) -->
    <a-box
      class="grabbable"
      position="-1 1.25 -3"
      depth="1.0" height="1.0" width="1.0"
      color="#ff6f61"
      material="roughness: 0.6; metalness: 0.1"
      shadow="cast: true; receive: true"
      dynamic-body="mass: 1"
      grabbable
    ></a-box>

    <a-sphere
      class="grabbable"
      position="1 1.5 -3"
      radius="0.5"
      color="#7db5ff"
      material="roughness: 0.4; metalness: 0.15"
      shadow="cast: true; receive: true"
      dynamic-body="mass: 1"
      grabbable
    ></a-sphere>

    <!-- Une pile de petits cubes √† saisir -->
    <a-box class="grabbable" position="0 0.5 -2.2" depth="0.5" height="0.5" width="0.5"
           color="#ffd166" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>
    <a-box class="grabbable" position="0.6 0.5 -2.2" depth="0.5" height="0.5" width="0.5"
           color="#06d6a0" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>
    <a-box class="grabbable" position="-0.6 0.5 -2.2" depth="0.5" height="0.5" width="0.5"
           color="#ef476f" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>

    <!-- RIG UTILISATEUR : d√©placement au joystick GAUCHE + cam√©ra -->
    <!-- movement-controls g√®re les d√©placements (Z/QS/DW = clavier & sticks en VR) -->
    <a-entity id="rig"
              position="0 1.6 3"
              movement-controls="fly: false; speed: 0.12; constrainToNavMesh: false">

      <!-- Cam√©ra (HMD en VR) -->
      <a-entity camera look-controls wasd-controls="enabled: false"></a-entity>

      <!-- MAIN GAUCHE : grab de proximit√© (sphere-collider) -->
      <a-entity id="leftHand"
                hand-controls="hand: left; handModelStyle: lowPoly; color: #ccccff"
                super-hands
                sphere-collider="objects: .grabbable"
      ></a-entity>

      <!-- MAIN DROITE : raycast + grab √† distance + rotation joystick droit -->
      <a-entity id="rightHand"
                hand-controls="hand: right; handModelStyle: highPoly; color: #ffcccc"
                super-hands
                raycaster="objects: .grabbable; showLine: true; far: 8"
                line="opacity: 0.9"
                turn-with-right-joystick="rig: #rig; turnSpeed: 2.2">
      </a-entity>
    </a-entity>

    <!-- Ciel l√©ger (optionnel) -->
    <a-sky color="#1b2026"></a-sky>
  </a-scene>
</body>
</html>
