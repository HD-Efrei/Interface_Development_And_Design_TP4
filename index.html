<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TP WebVR ‚Äì A-Frame 1.7.0 + super-hands 3.x (lasers fix + trigger move)</title>

  <!-- A-Frame 1.7.0 -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

  <!-- √âviter conflit de nom "grabbable" (super-hands) -->
  <script> if (AFRAME.components && AFRAME.components["grabbable"]) { delete AFRAME.components["grabbable"]; } </script>

  <!-- aframe-extras (movement-controls, sphere-collider) -->
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>

  <!-- Physics system (CANNON/Ammo support) -->
  <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.1.0/dist/aframe-physics-system.min.js"></script>

  <!-- super-hands 3.x -->
  <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .overlay {
      position: fixed; left: 12px; top: 12px; z-index: 9;
      background: rgba(0,0,0,.55); color:#fff; padding:10px 12px; border-radius:10px;
      font-size:14px; line-height:1.35;
    }
    .overlay kbd { background:#222; padding:2px 6px; border-radius:6px; }
  </style>

  <script>
    // Rotation du rig avec le joystick droit
    AFRAME.registerComponent('turn-with-right-joystick', {
      schema: { rig: {type: 'selector'}, speed: {default: 140} }, // ¬∞/s √† stick=1
      init() {
        this.x = 0; this.dead = 0.15;
        // On √©coute l'entit√© qui re√ßoit les events du contr√¥leur (la main parente)
        this.el.addEventListener('axismove', e => {
          if (e && e.detail && Array.isArray(e.detail.axis)) this.x = e.detail.axis[0] || 0;
        });
      },
      tick(t, dt) {
        const rig = this.data.rig; if (!rig) return;
        const stick = Math.abs(this.x) > this.dead ? this.x : 0; if (!stick) return;
        const rot = rig.getAttribute('rotation');
        rot.y -= stick * this.data.speed * (dt/1000);
        rig.setAttribute('rotation', rot);
      }
    });

    // Avancer quand on maintient la g√¢chette droite
    AFRAME.registerComponent('trigger-move', {
      schema: { rig: {type:'selector'}, camera: {type:'selector'}, speed: {default: 1.2} }, // m/s
      init() {
        this.moving = false;
        this.dir = new THREE.Vector3();
        this.el.addEventListener('triggerdown', () => { this.moving = true; });
        this.el.addEventListener('triggerup',   () => { this.moving = false; });
      },
      tick(t, dt) {
        if (!this.moving || !this.data.rig || !this.data.camera) return;
        const rig = this.data.rig.object3D;
        const cam = this.data.camera.object3D;
        // direction "avant" de la cam√©ra (XZ uniquement)
        cam.getWorldDirection(this.dir);
        this.dir.y = 0; this.dir.normalize();
        const step = (this.data.speed * dt/1000);
        rig.position.addScaledVector(this.dir, step);
      }
    });

    // Highlight des cibles au survol / grab
    AFRAME.registerComponent('hover-highlight', {
      schema: { hoverScale: {default: 1.06}, hoverEmissive: {default: '#ffffff'}, hoverIntensity: {default: 0.45} },
      init() {
        const el = this.el;
        this._origScale = el.object3D.scale.clone();
        this._getMat = () => {
          const mesh = el.getObject3D('mesh');
          if (!mesh) return null;
          return Array.isArray(mesh.material) ? mesh.material[0] : mesh.material;
        };
        const mat = this._getMat();
        this._origEmissive = (mat && mat.emissive) ? mat.emissive.clone() : null;
        this._origEmissiveIntensity = (mat && 'emissiveIntensity' in mat) ? mat.emissiveIntensity : 0;

        el.addEventListener('hover-start',  this._hs = () => this.setHover(true));
        el.addEventListener('hover-end',    this._he = () => this.setHover(false));
        el.addEventListener('grab-start',   this._gs = () => this.setHover(true));
        el.addEventListener('grab-end',     this._ge = () => this.setHover(false));
      },
      setHover(state) {
        const el = this.el;
        el.object3D.scale.setScalar(state ? this.data.hoverScale : this._origScale.x);
        const mat = this._getMat();
        if (mat) {
          if (state) {
            if (!mat.emissive) mat.emissive = new THREE.Color(this.data.hoverEmissive);
            else mat.emissive.set(this.data.hoverEmissive);
            mat.emissiveIntensity = this.data.hoverIntensity;
            mat.needsUpdate = true;
          } else {
            if (this._origEmissive) mat.emissive.copy(this._origEmissive);
            mat.emissiveIntensity = this._origEmissiveIntensity;
            mat.needsUpdate = true;
          }
        }
      },
      remove() {
        const el = this.el;
        el.removeEventListener('hover-start', this._hs);
        el.removeEventListener('hover-end', this._he);
        el.removeEventListener('grab-start', this._gs);
        el.removeEventListener('grab-end', this._ge);
      }
    });

    // Pointeur qui suit l‚Äôintersection du rayon (debug)
    AFRAME.registerComponent('ray-hit-dot', {
      schema: { raycasterEl: {type: 'selector'} },
      init() {
        this.visible = false;
        this.el.setAttribute('visible', 'false');
        const rc = this.data.raycasterEl;
        if (!rc) return;
        rc.addEventListener('raycaster-intersection', e => {
          if (!e.detail || !e.detail.intersections || !e.detail.intersections[0]) return;
          const p = e.detail.intersections[0].point;
          this.el.object3D.position.copy(p);
          if (!this.visible) { this.visible = true; this.el.setAttribute('visible', 'true'); }
        });
        rc.addEventListener('raycaster-intersection-cleared', () => {
          if (this.visible) { this.visible = false; this.el.setAttribute('visible', 'false'); }
        });
      }
    });
  </script>
</head>

<body>
  <div class="overlay">
    <strong>TP WebVR ‚Äì Ex.1 & Ex.2</strong><br/>
    üß≠ Gauche : joystick = d√©placement (laser court debug + grab proche)<br/>
    ‚Ü™Ô∏è Droit : joystick = rotation ‚Ä¢ <strong>G√¢chette droite = avancer</strong><br/>
    ü§è G√¢chettes : saisir / rel√¢cher ‚Ä¢ üîµ Point blanc = impact rayon droit<br/>
    üõ†Ô∏è Inspector : <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>I</kbd>
  </div>

  <a-scene
    background="color: #20252b"
    renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; sortTransparentObjects: true"
    shadow="type: pcfsoft"
    physics="debug: false; gravity: -9.8"
    vr-mode-ui="enabled: true"
  >
    <!-- Lumi√®res -->
    <a-entity light="type: ambient; intensity: 0.35; color: #ffffff"></a-entity>
    <a-entity light="type: directional; intensity: 1; castShadow: true"
              position="2 6 3" rotation="-45 30 0"></a-entity>

    <!-- Sol -->
    <a-plane rotation="-90 0 0" width="30" height="30"
             color="#3c424a" material="roughness:1; metalness:0"
             shadow="receive: true" static-body></a-plane>

    <!-- Objets dynamiques, saisissables, hoverables -->
    <a-box class="grabbable hoverable" hover-highlight
           position="-1 1.25 -3" width="1" height="1" depth="1"
           color="#ff6f61" material="roughness:.6; metalness:.1"
           shadow="cast: true; receive: true" dynamic-body grabbable></a-box>

    <a-sphere class="grabbable hoverable" hover-highlight
              position="1 1.5 -3" radius="0.5"
              color="#7db5ff" material="roughness:.4; metalness:.15"
              shadow="cast: true; receive: true" dynamic-body grabbable></a-sphere>

    <a-box class="grabbable hoverable" hover-highlight
           position="0 0.5 -2.2" width="0.5" height="0.5" depth="0.5"
           color="#ffd166" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>
    <a-box class="grabbable hoverable" hover-highlight
           position="0.6 0.5 -2.2" width="0.5" height="0.5" depth="0.5"
           color="#06d6a0" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>
    <a-box class="grabbable hoverable" hover-highlight
           position="-0.6 0.5 -2.2" width="0.5" height="0.5" depth="0.5"
           color="#ef476f" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>

    <!-- Rig + Cam√©ra + Mains -->
    <a-entity id="rig" position="0 1.6 3"
              movement-controls="fly:false; speed:0.12; constrainToNavMesh:false">
      <a-entity id="cam" camera look-controls wasd-controls="enabled:false"></a-entity>

      <!-- MAIN GAUCHE : main visible + laser court correct + grab proche -->
      <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #ccccff">
        <!-- rayon correctement orient√© par laser-controls (mod√®le ray uniquement) -->
        <a-entity id="leftPointer"
                  laser-controls="hand: left; model: false"
                  super-hands
                  sphere-collider="objects: .grabbable"
                  raycaster="objects: .grabbable; showLine: true; far: 2.2">
        </a-entity>
      </a-entity>

      <!-- MAIN DROITE : main visible + laser long + rotation joystick + avance g√¢chette -->
      <a-entity id="rightHand"
                hand-controls="hand: right; handModelStyle: highPoly; color: #ffcccc"
                turn-with-right-joystick="rig: #rig; speed: 140"
                trigger-move="rig: #rig; camera: #cam; speed: 1.2">
        <a-entity id="rightPointer"
                  laser-controls="hand: right; model: false"
                  super-hands
                  raycaster="objects: .grabbable; showLine: true; far: 8"
                  line="opacity: 0.95">
        </a-entity>
      </a-entity>
    </a-entity>

    <!-- Pointeur d'impact (rayon droit) -->
    <a-sphere id="hitDot" radius="0.02" color="#ffffff" visible="false"
              ray-hit-dot="raycasterEl: #rightPointer"></a-sphere>

    <a-sky color="#1b2026"></a-sky>
  </a-scene>
</body>
</html>
