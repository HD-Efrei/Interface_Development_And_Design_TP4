<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VR Grab + Move + Highlight (A-Frame 1.7.0)</title>

  <!-- A-Frame 1.7.0 -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

  <!-- √©viter le conflit de nom "grabbable" (introduit par A-Frame >=1.5) -->
  <script> if (AFRAME.components && AFRAME.components['grabbable']) { delete AFRAME.components['grabbable']; } </script>

  <!-- aframe-extras (movement-controls, sphere-collider, etc.) -->
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>

  <!-- Physics system -->
  <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.1.0/dist/aframe-physics-system.min.js"></script>

  <!-- super-hands 3.x -->
  <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .overlay {
      position: fixed; left: 12px; top: 12px; z-index: 9;
      background: rgba(0,0,0,.55); color:#fff; padding:10px 12px; border-radius:10px;
      font-size:14px; line-height:1.35;
    }
    .overlay kbd { background:#222; padding:2px 6px; border-radius:6px; }
  </style>

  <script>
    // Surbrillance (scale + √©missif) via les events super-hands: hover-start/hover-end
    AFRAME.registerComponent('hover-highlight', {
      schema: { scale: {default: 1.06}, emissive: {default:'#ffffff'}, intensity:{default:0.45} },
      init() {
        const el = this.el;
        this._s0 = el.object3D.scale.clone();
        const mesh = () => { const m = el.getObject3D('mesh'); return m ? (Array.isArray(m.material)?m.material[0]:m.material):null; };
        this._mat = mesh();
        this._e0 = (this._mat && this._mat.emissive) ? this._mat.emissive.clone() : null;
        this._i0 = (this._mat && 'emissiveIntensity' in this._mat) ? this._mat.emissiveIntensity : 0;

        el.addEventListener('hover-start',  () => this.set(true));
        el.addEventListener('hover-end',    () => this.set(false));
        el.addEventListener('grab-start',   () => this.set(true));
        el.addEventListener('grab-end',     () => this.set(false));
      },
      set(on){
        const el = this.el;
        el.object3D.scale.setScalar(on ? this.data.scale : this._s0.x);
        if (this._mat){
          if (on){
            (this._mat.emissive || (this._mat.emissive = new THREE.Color(this.data.emissive))).set(this.data.emissive);
            this._mat.emissiveIntensity = this.data.intensity;
          } else {
            if (this._e0) this._mat.emissive.copy(this._e0);
            this._mat.emissiveIntensity = this._i0;
          }
          this._mat.needsUpdate = true;
        }
      }
    });

    // Snap-turn simple au stick droit (paliers)
    AFRAME.registerComponent('snap-turn', {
      schema: { rig: {type:'selector'}, stepDeg: {default: 30}, threshold: {default: 0.6}, cooldownMs: {default: 220} },
      init() { this.stickX=0; this.last=0; this.el.addEventListener('axismove', e=>{ if(e.detail&&Array.isArray(e.detail.axis)) this.stickX=e.detail.axis[0]||0; }); },
      tick(t){
        const rig=this.data.rig; if(!rig) return;
        const now=t||performance.now(); if(now-this.last<this.data.cooldownMs) return;
        const x=this.stickX;
        if(x> this.data.threshold){ this.turn(-this.data.stepDeg); this.last=now; }
        else if(x<-this.data.threshold){ this.turn( this.data.stepDeg); this.last=now; }
      },
      turn(d){ const r=this.data.rig.getAttribute('rotation'); r.y+=d; this.data.rig.setAttribute('rotation', r); }
    });

    // Spawner : touche N ou bouton A (manette droite)
    AFRAME.registerComponent('spawner', {
      schema:{ camera:{type:'selector'} },
      init(){
        this.spawn = this.spawn.bind(this);
        window.addEventListener('keydown', e => { if (e.key.toLowerCase()==='n') this.spawn(); });
        this.el.addEventListener('abuttondown', this.spawn);
        // trois objets de d√©part
        setTimeout(()=>{ this.spawn(); this.spawn(); this.spawn(); }, 400);
      },
      spawn(){
        const camEl=this.data.camera; if(!camEl) return;
        const cam=camEl.object3D, dir=new THREE.Vector3(); cam.getWorldDirection(dir); dir.y=0; dir.normalize();
        const origin=camEl.object3D.getWorldPosition(new THREE.Vector3());
        const pos=origin.clone().add(dir.multiplyScalar(1.4)); pos.y=1.3;

        const isBox=Math.random()<0.5;
        const el=document.createElement(isBox?'a-box':'a-sphere');
        el.className='grab-target hoverable grabbable';
        if(isBox){ el.setAttribute('width',0.45); el.setAttribute('height',0.45); el.setAttribute('depth',0.45); }
        else{ el.setAttribute('radius',0.28); }
        el.setAttribute('color','#'+(Math.random()*0xFFFFFF|0).toString(16).padStart(6,'0'));
        el.setAttribute('position',`${pos.x} ${pos.y} ${pos.z}`);
        el.setAttribute('material','roughness:0.5; metalness:0.05');
        el.setAttribute('hover-highlight','');
        el.setAttribute('hoverable','');
        el.setAttribute('grabbable','');
        el.setAttribute('draggable','');
        el.setAttribute('dynamic-body','mass:1');
        document.querySelector('a-scene').appendChild(el);
      }
    });
  </script>
</head>

<body>
  <div class="overlay">
    <strong>Commandes</strong><br/>
    üß≠ Stick gauche : se d√©placer (movement-controls) ‚Ä¢ üîÅ Stick droit : snap-turn (30¬∞)<br/>
    ü§è G√¢chettes : grab / drop ‚Ä¢ üéØ Viser = surbrillance<br/>
    ‚ûï Spawn : <kbd>N</kbd> (clavier) ou bouton <b>A</b> (manette droite)
  </div>

  <a-scene
    background="color:#20252b"
    renderer="colorManagement:true; physicallyCorrectLights:true; antialias:true; sortTransparentObjects:true"
    shadow="type:pcfsoft"
    physics="gravity:-9.8; debug:false"
    vr-mode-ui="enabled:true"
  >
    <!-- lumi√®res -->
    <a-entity light="type:ambient; intensity:0.35; color:#ffffff"></a-entity>
    <a-entity light="type:directional; intensity:1; castShadow:true" position="2 6 3" rotation="-45 30 0"></a-entity>

    <!-- sol -->
    <a-plane rotation="-90 0 0" width="30" height="30"
             color="#3c424a" material="roughness:1; metalness:0"
             shadow="receive:true" static-body></a-plane>

    <!-- RIG avec movement-controls (loco par stick gauche) -->
    <a-entity id="rig" position="0 1.6 3"
              movement-controls="fly:true; speed:0.18; constrainToNavMesh:false">
      <a-entity id="cam" camera look-controls wasd-controls="enabled:false"></a-entity>

      <!-- MAIN GAUCHE : laser par d√©faut + collider de proximit√© + raycaster explicite -->
      <a-entity id="left"
                laser-controls="hand: left"
                super-hands
                sphere-collider="objects: .grab-target"
                raycaster="objects: .grab-target; showLine: true; far: 8">
      </a-entity>

      <!-- MAIN DROITE : laser par d√©faut + snap-turn + spawner -->
      <a-entity id="right"
                laser-controls="hand: right"
                super-hands
                snap-turn="rig: #rig; stepDeg: 30; threshold: 0.6; cooldownMs: 220"
                spawner="camera: #cam"
                raycaster="objects: .grab-target; showLine: true; far: 8">
      </a-entity>
    </a-entity>

    <a-sky color="#1b2026"></a-sky>
  </a-scene>
</body>
</html>
