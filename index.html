<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TP WebVR ‚Äì A-Frame 1.7.0 (lasers par d√©faut + locomotion sticks)</title>

  <!-- A-Frame 1.7.0 -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

  <!-- √âviter conflit de nom "grabbable" (super-hands) -->
  <script> if (AFRAME.components && AFRAME.components["grabbable"]) { delete AFRAME.components["grabbable"]; } </script>

  <!-- aframe-extras (on ne prend QUE ce dont on a besoin, pas movement-controls) -->
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>

  <!-- Physics system -->
  <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.1.0/dist/aframe-physics-system.min.js"></script>

  <!-- super-hands 3.x -->
  <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .overlay {
      position: fixed; left: 12px; top: 12px; z-index: 9;
      background: rgba(0,0,0,.55); color:#fff; padding:10px 12px; border-radius:10px;
      font-size:14px; line-height:1.35;
    }
    .overlay kbd { background:#222; padding:2px 6px; border-radius:6px; }
  </style>

  <script>
    // D√©placement analogique avec le JOYSTICK GAUCHE (sans movement-controls)
    // Ecoute 'axismove' de la main gauche (laser-controls) et translate le RIG sur X/Z.
    AFRAME.registerComponent('thumb-move', {
      schema: { rig: {type:'selector'}, speed: {default: 1.5}, dead: {default: 0.18} }, // m/s
      init() {
        this.x = 0; this.y = 0;
        this.dir = new THREE.Vector3();
        this.el.addEventListener('axismove', e => {
          if (!e.detail || !Array.isArray(e.detail.axis)) return;
          // axis[0] = gauche/droite, axis[1] = avant/arri√®re (vers l'AVANT = n√©gatif sur Oculus)
          this.x = e.detail.axis[0] || 0;
          this.y = e.detail.axis[1] || 0;
        });
      },
      tick(t, dt) {
        const rig = this.data.rig && this.data.rig.object3D;
        if (!rig) return;
        const dead = this.data.dead;
        const ax = (Math.abs(this.x) > dead) ? this.x : 0;
        const ay = (Math.abs(this.y) > dead) ? this.y : 0;
        if (!ax && !ay) return;

        // D√©placement relatif √† l'orientation Y du rig (comme un FPS)
        const yaw = THREE.MathUtils.degToRad(this.data.rig.getAttribute('rotation').y);
        const cos = Math.cos(yaw), sin = Math.sin(yaw);

        // Sur Oculus, pousser le stick vers l'avant donne axis[1] ~ -1
        // Donc "avant" = -ay
        const forward = -ay, strafe = ax;

        const dx = (strafe * cos + forward * sin) * this.data.speed * (dt/1000);
        const dz = (forward * cos - strafe * sin) * this.data.speed * (dt/1000);

        rig.position.x += dx;
        rig.position.z += dz;
      }
    });

    // Snap-turn au JOYSTICK DROIT (paliers)
    AFRAME.registerComponent('snap-turn', {
      schema: { rig: {type:'selector'}, stepDeg: {default: 30}, threshold: {default: 0.6}, cooldownMs: {default: 220} },
      init() {
        this.lastTime = 0;
        this.stickX = 0;
        this.el.addEventListener('axismove', e => {
          if (!e.detail || !Array.isArray(e.detail.axis)) return;
          this.stickX = e.detail.axis[0] || 0; // horizontal
        });
      },
      tick(t) {
        const rig = this.data.rig;
        if (!rig) return;
        const now = t || performance.now();
        if (now - this.lastTime < this.data.cooldownMs) return;

        const x = this.stickX;
        if (x > this.data.threshold) {
          this.turn(-this.data.stepDeg); // droite -> tourner √† droite (sens horaire)
          this.lastTime = now;
        } else if (x < -this.data.threshold) {
          this.turn(this.data.stepDeg);  // gauche -> tourner √† gauche
          this.lastTime = now;
        }
      },
      turn(deltaDeg) {
        const rot = this.data.rig.getAttribute('rotation');
        rot.y += deltaDeg;
        this.data.rig.setAttribute('rotation', rot);
      }
    });

    // Effet survol / grab
    AFRAME.registerComponent('hover-highlight', {
      schema: { hoverScale: {default: 1.06}, hoverEmissive: {default: '#ffffff'}, hoverIntensity: {default: 0.45} },
      init() {
        const el = this.el;
        this._origScale = el.object3D.scale.clone();
        this._getMat = () => {
          const mesh = el.getObject3D('mesh');
          if (!mesh) return null;
          return Array.isArray(mesh.material) ? mesh.material[0] : mesh.material;
        };
        const mat = this._getMat();
        this._origEmissive = (mat && mat.emissive) ? mat.emissive.clone() : null;
        this._origEmissiveIntensity = (mat && 'emissiveIntensity' in mat) ? mat.emissiveIntensity : 0;

        el.addEventListener('hover-start',  this._hs = () => this.setHover(true));
        el.addEventListener('hover-end',    this._he = () => this.setHover(false));
        el.addEventListener('grab-start',   this._gs = () => this.setHover(true));
        el.addEventListener('grab-end',     this._ge = () => this.setHover(false));
      },
      setHover(state) {
        const el = this.el;
        el.object3D.scale.setScalar(state ? this.data.hoverScale : this._origScale.x);
        const mat = this._getMat();
        if (mat) {
          if (state) { (mat.emissive || (mat.emissive = new THREE.Color(this.data.hoverEmissive))).set(this.data.hoverEmissive);
            mat.emissiveIntensity = this.data.hoverIntensity; mat.needsUpdate = true; }
          else { if (this._origEmissive) mat.emissive.copy(this._origEmissive);
            mat.emissiveIntensity = this._origEmissiveIntensity; mat.needsUpdate = true; }
        }
      },
      remove() {
        const el = this.el;
        el.removeEventListener('hover-start', this._hs);
        el.removeEventListener('hover-end', this._he);
        el.removeEventListener('grab-start', this._gs);
        el.removeEventListener('grab-end', this._ge);
      }
    });
  </script>
</head>

<body>
  <div class="overlay">
    <strong>Commandes</strong><br/>
    üß≠ <b>Stick gauche</b> : se d√©placer (avant/arri√®re/gauche/droite)<br/>
    üîÅ <b>Stick droit</b> : rotation par paliers (snap-turn)<br/>
    ü§è <b>G√¢chettes</b> : saisir / rel√¢cher (super-hands)<br/>
    üéØ Lasers ‚Äúpar d√©faut‚Äù d‚ÄôA-Frame (sortent des manettes)
  </div>

  <a-scene
    background="color: #20252b"
    renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; sortTransparentObjects: true"
    shadow="type: pcfsoft"
    physics="debug: false; gravity: -9.8"
    vr-mode-ui="enabled: true"
  >
    <!-- Lumi√®res -->
    <a-entity light="type: ambient; intensity: 0.35; color: #ffffff"></a-entity>
    <a-entity light="type: directional; intensity: 1; castShadow: true"
              position="2 6 3" rotation="-45 30 0"></a-entity>

    <!-- Sol -->
    <a-plane rotation="-90 0 0" width="30" height="30"
             color="#3c424a" material="roughness:1; metalness:0"
             shadow="receive: true" static-body></a-plane>

    <!-- Objets dynamiques -->
    <a-box class="grabbable hoverable" hover-highlight
           position="-1 1.25 -3" width="1" height="1" depth="1"
           color="#ff6f61" material="roughness:.6; metalness:.1"
           shadow="cast: true; receive: true" dynamic-body grabbable></a-box>

    <a-sphere class="grabbable hoverable" hover-highlight
              position="1 1.5 -3" radius="0.5"
              color="#7db5ff" material="roughness:.4; metalness:.15"
              shadow="cast: true; receive: true" dynamic-body grabbable></a-sphere>

    <a-box class="grabbable hoverable" hover-highlight
           position="0 0.5 -2.2" width="0.5" height="0.5" depth="0.5"
           color="#ffd166" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>
    <a-box class="grabbable hoverable" hover-highlight
           position="0.6 0.5 -2.2" width="0.5" height="0.5" depth="0.5"
           color="#06d6a0" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>
    <a-box class="grabbable hoverable" hover-highlight
           position="-0.6 0.5 -2.2" width="0.5" height="0.5" depth="0.5"
           color="#ef476f" shadow="cast: true; receive: true" dynamic-body grabbable></a-box>

    <!-- RIG + Cam√©ra -->
    <a-entity id="rig" position="0 1.6 3">
      <a-entity id="cam" camera look-controls wasd-controls="enabled:false"></a-entity>

      <!-- MAIN GAUCHE : lasers par d√©faut + locomotion stick gauche -->
      <a-entity id="left"
                laser-controls="hand: left"
                super-hands
                thumb-move="rig: #rig; speed: 1.6; dead: 0.18"
                sphere-collider="objects: .grabbable">
      </a-entity>

      <!-- MAIN DROITE : lasers par d√©faut + snap-turn stick droit -->
      <a-entity id="right"
                laser-controls="hand: right"
                super-hands
                snap-turn="rig: #rig; stepDeg: 30; threshold: 0.6; cooldownMs: 220">
      </a-entity>
    </a-entity>

    <a-sky color="#1b2026"></a-sky>
  </a-scene>
</body>
</html>
